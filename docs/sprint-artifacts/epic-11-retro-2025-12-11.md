# Epic 11 Retrospective: Tax & Compliance

**Date:** 2025-12-11
**Facilitator:** Bob (Scrum Master)
**Epic Status:** Complete (3/3 stories done)

---

## Epic Summary

| Metric | Value |
|--------|-------|
| Epic | 11 - Tax & Compliance |
| Stories Completed | 3/3 (100%) |
| FRs Implemented | FR119-124 (6 FRs) |
| Business Value | IRS 1099-MISC compliance for US publishers |

### Stories Delivered

| Story | Title | Key Deliverables |
|-------|-------|------------------|
| 11-1 | Collect & Validate Tax ID | TIN encryption (AES-256-GCM), SSN/EIN validation, W-9 tracking |
| 11-2 | Track Annual Earnings | Tax preparation report, threshold flagging, CSV export |
| 11-3 | Generate 1099-MISC Forms | PDF generation, batch processing, payer info |

### Technical Highlights

- AES-256-GCM encryption for TIN storage with dedicated `TIN_ENCRYPTION_KEY`
- Auto-formatting validation for SSN (XXX-XX-XXXX) and EIN (XX-XXXXXXX)
- Tax Preparation Report with earnings aggregation by calendar year
- 1099-MISC PDF generation following IRS specifications
- Tenant payer information for 1099 Box A (payer details)

---

## What Went Well

### 1. Security-First Implementation
TIN encryption was implemented correctly with AES-256-GCM, separate encryption key, and proper masking in UI. TIN values are never logged or exposed unnecessarily.

### 2. Comprehensive Validation
SSN and EIN validation with auto-formatting provides good UX while ensuring data integrity. The `tin-validation.ts` utility handles all edge cases.

### 3. Reusable Component Patterns
Tax Preparation Report followed existing reporting patterns (stat cards, filters, CSV export). No reinventing the wheel.

### 4. Test Coverage
Story 11.1 alone had 108+ tests covering TIN validation, encryption, schema validation, and form behavior.

---

## Issues Discovered & Fixed During Retrospective

### 1. Database Migration Not Applied (CRITICAL)

**Problem:** Payer information columns (`payer_ein_encrypted`, `payer_name`, etc.) were defined in schema but not pushed to database.

**Impact:** Application crashed when accessing tenant data.

**Resolution:** Ran `npx drizzle-kit push` to apply schema changes.

**Root Cause:** Story marked "done" without verifying database migration was applied.

### 2. Incorrect 1099 Royalty Threshold (CRITICAL)

**Problem:** Code used $600 threshold instead of correct $10 threshold for royalties.

**Background:** Epic 10 retrospective identified this issue and documented it as a critical action item. The fix was not implemented before Epic 11 started.

**Impact:** Would have missed generating 1099s for authors earning $10-$599 in royalties, causing IRS compliance failures.

**Resolution:** Updated `IRS_1099_THRESHOLD` and `FILING_THRESHOLD` constants from 600 to 10 across 13 files:
- `src/modules/reports/queries/tax-preparation-utils.ts`
- `src/modules/form-1099/actions.ts`
- `src/modules/reports/queries/tax-preparation.ts`
- `src/modules/reports/components/tax-preparation-stats.tsx`
- `src/modules/reports/components/tax-preparation-warning.tsx`
- `src/modules/reports/components/tax-preparation-table.tsx`
- `src/modules/form-1099/components/form-1099-stats.tsx`
- `src/modules/form-1099/components/form-1099-generation-client.tsx`
- `src/modules/form-1099/types.ts`
- `src/modules/tenant/components/payer-info-form.tsx`
- `docs/epics.md` (5 locations)

**IRS Reference:** Form 1099-MISC Instructions, Box 2 (Royalties) requires reporting for payments of $10 or more.

### 3. React Controlled Input Warning

**Problem:** Console error "A component is changing an uncontrolled input to be controlled" in contact-detail.tsx.

**Root Cause:** `tax_id` field used in form but not initialized in `defaultValues`.

**Resolution:** Added `tax_id: ""` to both `defaultValues` and `form.reset()` calls.

### 4. Missing Tax Info Edit Capability (UX Gap)

**Problem:** Tax Information section displayed read-only status (TIN, W-9) but provided no way for users to edit it.

**Impact:** Users could see "Incomplete" status but had no obvious path to fix it.

**Resolution:** Added:
- "Edit" button to TaxInfoDisplay section (permission-gated to VIEW_TAX_ID)
- Tax Info Edit Dialog with full TaxInfoForm component
- Handler functions for opening dialog and saving tax info
- Integration with existing `updateContactTaxInfoPartial` action

---

## Configuration Requirements

### TIN Encryption Key Setup

The TIN encryption feature requires a dedicated encryption key:

```bash
# Generate a 32-byte hex key
openssl rand -hex 32

# Add to .env file
TIN_ENCRYPTION_KEY=<your-64-character-hex-key>
```

**Note:** This is a security requirement, not a bug. TINs cannot be stored without proper encryption configured.

---

## Epic 10 Action Item Follow-Through

| # | Action Item from Epic 10 | Status |
|---|--------------------------|--------|
| 1 | Update Epic 11 with correct $10 royalty threshold | **Fixed during retro** |
| 2 | Update sprint-status.yaml to mark Epic 10 as done | Done |
| 3 | Keep sprint-status.yaml in sync | Partially addressed |
| 4 | Investigate root cause of story churn | Not addressed |
| 5 | Establish clearer Definition of Done | Not addressed |

**Observation:** Critical action items from Epic 10 were not fully addressed before Epic 11 implementation began. This led to the $600 threshold being carried into production code.

---

## Process Issues Identified

### 1. Definition of Done Gaps

Stories are being marked "done" without full verification:
- Database migrations not applied
- Previous retro action items not checked
- Configuration requirements not documented

### 2. Sprint Status Drift (Recurring)

Same issue from Epic 10: sprint-status.yaml showed stories as "in-progress" when they were actually complete.

### 3. Action Item Tracking

No systematic process for ensuring retro action items are addressed before next epic begins.

---

## Future Enhancement Recommendations

### 1. Author Portal W-9 Self-Service

**Problem:** Currently, only Finance/Admin users can enter tax information for authors. Authors have no way to submit their own W-9 data.

**Proposed Enhancement:**
- Add tax info submission form to Author Portal
- Allow authors to enter TIN and certify W-9 electronically
- Add document upload capability for signed W-9 PDFs
- Create review/approval workflow for Finance to verify submissions
- Send email notifications on submission and approval

**Business Value:** Reduces manual data entry burden on Finance staff, improves author onboarding experience.

### 2. Stripe Connect Integration (Post-MVP)

**Problem:** Salina currently handles all tax compliance (TIN collection, encryption, 1099 generation) internally.

**Alternative:** Stripe Connect provides complete tax compliance solution:
- W-9/W-8 collection via Stripe's secure UI
- TIN storage on Stripe's PCI-compliant servers
- Automatic 1099 generation and IRS e-filing ($2.99/form)
- State filing ($1.49/form)
- E-delivery to payees via Stripe Express dashboard
- Enforcement options (block payouts until W-9 submitted)

**Recommendation:** Evaluate Stripe Connect integration post-MVP for publishers using Stripe for payments. Could significantly reduce compliance burden.

**Trade-offs:**
- Pro: Offloads security/compliance burden to Stripe
- Pro: Authors manage tax info directly with Stripe
- Con: Per-form fees ($2.99 federal + $1.49 state)
- Con: Requires Stripe Connect account structure

---

## Action Items

### Process Improvements (High Priority)

| # | Action Item | Owner | Priority |
|---|-------------|-------|----------|
| 1 | Create Definition of Done checklist including: DB migration verification, retro action items check, configuration documentation | Bob (SM) | High |
| 2 | Add pre-epic checklist to verify previous retro action items are addressed | Bob (SM) | High |
| 3 | Automate sprint-status.yaml sync or establish clear update protocol | Dev Team | Medium |

### Technical Debt

| # | Item | Priority |
|---|------|----------|
| 1 | Add E2E tests for tax info edit flow | Medium |
| 2 | Add integration tests for TIN encryption/decryption | Medium |

### Documentation

| # | Item | Priority |
|---|------|----------|
| 1 | Document TIN_ENCRYPTION_KEY setup in deployment guide | High |
| 2 | Add W-9 self-service to product backlog | Low |
| 3 | Create Stripe Connect evaluation document for post-MVP | Low |

---

## Next Epic Preview

**Epic 13: Platform Administration**
- Goal: SaaS operator tools for tenant management and monitoring
- Stories: 8 (13-1 through 13-8)
- FRs: FR125-134

**Key Characteristics:**
- Different context: Building for platform operators, not tenants
- New route group: `/platform-admin`
- Cross-tenant queries (bypassing RLS)
- Platform admin authentication separate from tenant auth

**Dependencies on Epic 11:**
- Audit logging patterns established
- Multi-tenant security patterns proven
- PDF generation patterns available for reuse

---

## Lessons Learned

1. **Check previous retro action items before starting new epic** - The $10 threshold issue was documented in Epic 10 but not addressed
2. **Verify database migrations are applied** - Schema changes don't automatically deploy
3. **Components need integration, not just creation** - TaxInfoForm existed but wasn't wired into the edit flow
4. **Configuration requirements must be documented** - TIN_ENCRYPTION_KEY is a security requirement, not a bug
5. **Consider platform alternatives early** - Stripe Connect could have influenced Epic 11 scope

---

## Retrospective Effectiveness

This retrospective discovered and fixed 4 issues during the session:
1. Database migration gap
2. $10 threshold compliance issue
3. React controlled input warning
4. Tax info edit UX gap

**Value demonstrated:** Real bugs caught and fixed, compliance issue prevented, UX gap closed.

---

## Team Acknowledgments

- **Eric (Project Lead)** - Sharp testing caught multiple issues during retro
- **BMad** - Original $10 threshold discovery in Epic 10
- **Dev Team** - Solid encryption and validation implementation

---

*Retrospective facilitated by Bob (Scrum Master Agent)*
