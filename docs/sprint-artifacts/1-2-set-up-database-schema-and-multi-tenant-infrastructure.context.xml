<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.2</storyId>
    <title>Set Up Database Schema and Multi-Tenant Infrastructure</title>
    <status>drafted</status>
    <generatedAt>2025-11-22</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-2-set-up-database-schema-and-multi-tenant-infrastructure.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>development team</asA>
    <iWant>to establish the database schema with Row-Level Security (RLS) for multi-tenant data isolation</iWant>
    <soThat>publishing companies can operate securely on a shared infrastructure with complete data separation</soThat>
    <tasks>
      - Configure Drizzle ORM connection (AC: #1, #2)
      - Create tenants table schema (AC: #3)
      - Create users table schema (AC: #4, #5, #6)
      - Generate and apply Drizzle migrations (AC: #7, #8)
      - Enable Row-Level Security (AC: #9, #10)
      - Add database utility scripts (AC: #11)
      - Create cross-tenant isolation test (AC: #12)
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Drizzle ORM is configured with Neon PostgreSQL connection (drizzle.config.ts created)</criterion>
    <criterion id="2">Database connection established in src/db/index.ts using @neondatabase/serverless driver</criterion>
    <criterion id="3">tenants table schema created in src/db/schema/tenants.ts with all required columns (id, subdomain, name, timezone, fiscal_year_start, default_currency, statement_frequency, created_at, updated_at)</criterion>
    <criterion id="4">users table schema created in src/db/schema/users.ts with all required columns (id, tenant_id, clerk_user_id, email, role, is_active, created_at, updated_at)</criterion>
    <criterion id="5">Foreign key constraint: users.tenant_id â†’ tenants.id with ON DELETE CASCADE</criterion>
    <criterion id="6">Unique constraints enforced on tenants.subdomain and users.clerk_user_id</criterion>
    <criterion id="7">Drizzle migrations generated via npm run db:generate</criterion>
    <criterion id="8">Migrations successfully applied to Neon database via npm run db:migrate</criterion>
    <criterion id="9">Row-Level Security (RLS) enabled on both tenants and users tables</criterion>
    <criterion id="10">RLS policies created for tenant isolation (users table and tenants table policies)</criterion>
    <criterion id="11">Database can be inspected via Drizzle Studio (npm run db:studio)</criterion>
    <criterion id="12">Automated test verifies cross-tenant isolation: Query as Tenant A returns no Tenant B data</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Foundation & Multi-Tenant Infrastructure</title>
        <section>Data Models and Contracts</section>
        <snippet>Database tables for tenants and users with RLS policies. Tenants table contains id, subdomain, name, timezone, fiscal_year_start, default_currency, statement_frequency. Users table contains id, tenant_id, clerk_user_id, email, role, is_active with foreign key to tenants.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Salina Bookshelf ERP - Decision Architecture</title>
        <section>Multi-Tenant Row-Level Security</section>
        <snippet>Three-layer security: Middleware (tenant context), Application (query injection), Database (RLS policies). RLS enforces tenant_id isolation at PostgreSQL level using session variable app.current_tenant_id.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Salina Bookshelf ERP - Decision Architecture</title>
        <section>Database Schema</section>
        <snippet>Core tables use pgTable API with uuid primary keys, timestamps (created_at, updated_at), snake_case naming. Foreign keys use ON DELETE CASCADE. Unique constraints on subdomain and clerk_user_id.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Salina Bookshelf ERP - Decision Architecture</title>
        <section>Naming Conventions</section>
        <snippet>Tables: plural snake_case. Columns: snake_case. Foreign keys: {table}_id format. Boolean columns: is_ or has_ prefix. Timestamps: created_at, updated_at always included.</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Salina ERP - Product Requirements Document</title>
        <section>Multi-Tenancy Architecture</section>
        <snippet>Shared-table pattern with tenant_id column. PostgreSQL Row-Level Security enforces isolation. Subdomain routing for tenant access. Defense in depth with middleware, application, and database layers.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>drizzle.config.ts</path>
        <kind>config</kind>
        <symbol>defineConfig</symbol>
        <lines>1-10</lines>
        <reason>Already configured - Drizzle Kit config pointing to schema and migrations directories, using Neon PostgreSQL dialect</reason>
      </artifact>
      <artifact>
        <path>src/db/index.ts</path>
        <kind>database-client</kind>
        <symbol>db</symbol>
        <lines>1-6</lines>
        <reason>Already implemented - Database client export using neon-http driver with schema loaded</reason>
      </artifact>
      <artifact>
        <path>src/db/schema/tenants.ts</path>
        <kind>schema</kind>
        <symbol>tenants</symbol>
        <lines>1-13</lines>
        <reason>Already implemented - Tenants table schema with all required columns, unique subdomain constraint, timestamps</reason>
      </artifact>
      <artifact>
        <path>src/db/schema/users.ts</path>
        <kind>schema</kind>
        <symbol>users</symbol>
        <lines>1-22</lines>
        <reason>Already implemented - Users table schema with tenant_id foreign key (ON DELETE CASCADE), role enum, unique clerk_user_id, indexes on tenant_id and email</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package name="drizzle-orm" version="^0.44.7" type="production" />
        <package name="@neondatabase/serverless" version="^1.0.2" type="production" />
        <package name="drizzle-kit" version="^0.31.7" type="development" />
        <package name="@types/node" version="^24.10.1" type="development" />
        <package name="typescript" version="^5.9.3" type="development" />
        <package name="@playwright/test" version="^1.56.1" type="development" />
        <package name="@faker-js/faker" version="^10.1.0" type="development" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>All tenant-scoped tables MUST have RLS enabled to prevent data leakage (security-critical)</constraint>
    <constraint>Use Drizzle's pgTable API for schema definitions, not raw SQL</constraint>
    <constraint>RLS policies reference PostgreSQL session variable app.current_tenant_id (set by middleware in Story 1.3)</constraint>
    <constraint>Migrations are versioned and must be applied in order for production safety</constraint>
    <constraint>Database naming: Tables plural snake_case, columns snake_case, foreign keys {table}_id format</constraint>
    <constraint>All tables require created_at and updated_at timestamps with timezone</constraint>
    <constraint>Boolean columns use is_ or has_ prefix (e.g., is_active)</constraint>
    <constraint>Foreign keys should specify ON DELETE behavior (CASCADE for dependent data)</constraint>
    <constraint>Unique constraints must be enforced on natural keys (subdomain, clerk_user_id)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>db (Drizzle client)</name>
      <kind>database-orm</kind>
      <signature>export const db = drizzle(sql, { schema })</signature>
      <path>src/db/index.ts</path>
    </interface>
    <interface>
      <name>tenants schema</name>
      <kind>drizzle-table</kind>
      <signature>pgTable("tenants", { id: uuid, subdomain: text.unique, name: text, timezone: text, fiscal_year_start: date, default_currency: text, statement_frequency: text, created_at: timestamp, updated_at: timestamp })</signature>
      <path>src/db/schema/tenants.ts</path>
    </interface>
    <interface>
      <name>users schema</name>
      <kind>drizzle-table</kind>
      <signature>pgTable("users", { id: uuid, tenant_id: uuid.references(tenants.id), clerk_user_id: text.unique, email: text, role: text.enum, is_active: boolean, created_at: timestamp, updated_at: timestamp })</signature>
      <path>src/db/schema/users.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing approach combines unit, integration, and E2E tests. Use Playwright for E2E tests (@playwright/test installed). Database integration tests should use isolated Neon instance or test database. Cross-tenant isolation tests are CRITICAL for security validation. Use @faker-js/faker for realistic test data generation.
    </standards>
    <locations>
      <location>tests/e2e/*.spec.ts</location>
      <location>tests/integration/*.test.ts</location>
      <location>tests/unit/*.test.ts</location>
    </locations>
    <ideas>
      <idea ac="1,2">Unit test: Verify drizzle.config.ts loads correctly and db client exports successfully</idea>
      <idea ac="3,4">Unit test: Validate Drizzle schema types for tenants and users tables match specification</idea>
      <idea ac="5,6">Integration test: Create tenant and user, verify foreign key constraint and unique constraints enforced</idea>
      <idea ac="7,8">Integration test: Generate migration, apply to test database, verify tables created with correct schema</idea>
      <idea ac="9,10">E2E test: Enable RLS, set session variable, verify policies enforce tenant isolation (CRITICAL security test)</idea>
      <idea ac="11">Manual test: Run npm run db:studio and verify both tables visible with correct schema</idea>
      <idea ac="12">E2E test: Create Tenant A with data, authenticate as Tenant B, query data with RLS active, assert zero Tenant A records returned (cross-tenant isolation validation)</idea>
    </ideas>
  </tests>
</story-context>
