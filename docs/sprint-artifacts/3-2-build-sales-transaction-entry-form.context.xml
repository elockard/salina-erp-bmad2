<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>2</storyId>
    <title>Build Sales Transaction Entry Form</title>
    <status>drafted</status>
    <generatedAt>2025-11-25</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-2-build-sales-transaction-entry-form.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>editor</asA>
    <iWant>to quickly record individual sales transactions</iWant>
    <soThat>sales data feeds accurate royalty calculations</soThat>
    <tasks>
      <task id="1" acs="2,3,7">Create sales module structure and types
        <subtask>Create src/modules/sales/types.ts with form types</subtask>
        <subtask>Create src/modules/sales/queries.ts with title search query</subtask>
        <subtask>Add searchTitlesForSales query returning titles with ISBN info</subtask>
        <subtask>Define TitleForSalesSelect type with id, title, author_name, has_isbn, has_eisbn</subtask>
      </task>
      <task id="2" acs="2,10,12">Create sales Server Actions
        <subtask>Create src/modules/sales/actions.ts with "use server" directive</subtask>
        <subtask>Add searchTitlesAction for autocomplete with debounce-friendly design</subtask>
        <subtask>Add recordSale action validating with createSaleSchema</subtask>
        <subtask>Compute total_amount server-side using Decimal.js</subtask>
        <subtask>Include tenant_id and created_by_user_id from auth context</subtask>
        <subtask>Add permission check for Editor/Finance/Admin/Owner</subtask>
        <subtask>Return ActionResult&lt;Sale&gt; with success/error</subtask>
      </task>
      <task id="3" acs="2">Build title autocomplete component
        <subtask>Create src/modules/sales/components/title-autocomplete.tsx</subtask>
        <subtask>Use shadcn/ui Command + Popover components</subtask>
        <subtask>Implement debounced search (300ms) using useTransition</subtask>
        <subtask>Display title with author name and format badges</subtask>
        <subtask>Filter to only show titles with assigned ISBNs</subtask>
        <subtask>Handle empty state and loading state</subtask>
      </task>
      <task id="4" acs="1-9">Build sales form component
        <subtask>Create src/modules/sales/components/sales-form.tsx</subtask>
        <subtask>Use React Hook Form with Zod resolver</subtask>
        <subtask>Wire up all form fields per acceptance criteria</subtask>
        <subtask>Implement format dropdown that filters based on title selection</subtask>
        <subtask>Add real-time total calculation using Decimal.js</subtask>
        <subtask>Store last-used channel in localStorage</subtask>
        <subtask>Apply UX "Spacious Guided Flow" styling</subtask>
      </task>
      <task id="5" acs="1,9">Create sales entry page
        <subtask>Create src/app/(dashboard)/sales/new/page.tsx</subtask>
        <subtask>Add page header with breadcrumb navigation</subtask>
        <subtask>Import and render SalesForm component</subtask>
        <subtask>Add "Quick Actions" breadcrumb: Dashboard &gt; Sales &gt; Record Sale</subtask>
      </task>
      <task id="6" acs="10,11">Implement form submission handling
        <subtask>Handle form submission with useTransition</subtask>
        <subtask>Show loading spinner on submit button</subtask>
        <subtask>Display success toast with sale details</subtask>
        <subtask>Clear form except channel on success</subtask>
        <subtask>Return focus to title field</subtask>
        <subtask>Handle and display server errors</subtask>
      </task>
      <task id="7" acs="12">Add permission gate and navigation
        <subtask>Add route protection in middleware for /sales/new</subtask>
        <subtask>Create "Record Sale" quick action button on dashboard</subtask>
        <subtask>Add "Record Sale" link in sales module navigation</subtask>
        <subtask>Verify unauthorized users get redirected properly</subtask>
      </task>
      <task id="8" acs="1-12">Write unit tests for sales form
        <subtask>Create tests/unit/sales-form.test.ts</subtask>
        <subtask>Test Zod schema validation for all fields</subtask>
        <subtask>Test total calculation with Decimal.js</subtask>
        <subtask>Test form state management</subtask>
        <subtask>Test permission checking logic</subtask>
      </task>
      <task id="9" acs="1-12">Write E2E tests for sales entry
        <subtask>Create tests/e2e/sales-entry.spec.ts</subtask>
        <subtask>Test complete sales entry flow</subtask>
        <subtask>Test validation error display</subtask>
        <subtask>Test title search and selection</subtask>
        <subtask>Test permission denial for unauthorized roles</subtask>
        <subtask>Test form persistence of channel selection</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Sales entry page at /sales/new with form per UX "Spacious Guided Flow" - Page header: "Record Sales Transaction", Subtitle: "Enter sales data for accurate royalty calculations", Form centered with max-width constraint</criterion>
    <criterion id="2">Title autocomplete search field (required, focus on page load) - Type to search, dropdown shows: "[Title] ([Author]) - Physical, Ebook", Shows only titles with at least one format available (has ISBN or eISBN assigned), Debounced search (300ms) using Server Action</criterion>
    <criterion id="3">Format dropdown (required) - Pre-filtered based on selected title's available formats, Options: Physical Book / Ebook / Audiobook (only show formats with assigned ISBN), Disabled until title selected</criterion>
    <criterion id="4">Quantity number input (required) - Placeholder: "0", Validation: positive integer &gt; 0, Keyboard-optimized (type="number")</criterion>
    <criterion id="5">Unit Price currency input (required) - Placeholder: "$0.00", Validation: positive number &gt; 0 with max 2 decimal places, Formatted with currency prefix, Helper text: "Price per unit sold"</criterion>
    <criterion id="6">Sale Date date picker (defaults to today) - Calendar component from shadcn/ui, Cannot be future date, Formatted display in tenant timezone</criterion>
    <criterion id="7">Sales Channel dropdown (required) - Options: Retail, Wholesale, Direct, Distributor, Remembers last-used as default (localStorage), Default to "retail" if no previous selection</criterion>
    <criterion id="8">Real-time calculation preview - Displays: "Total Transaction Value: $X,XXX.XX" (quantity x unit_price), Updates live as user types, Uses Decimal.js for calculation accuracy, Formatted with Intl.NumberFormat</criterion>
    <criterion id="9">Submit button with calculated total - Button text: "Record Sale ($X,XXX.XX)", Loading state with spinner during submission, Disabled when form invalid</criterion>
    <criterion id="10">On successful submission - Server Action validates with Zod schema, Inserts sale record with tenant_id and created_by_user_id, Computes total_amount server-side using Decimal.js, Success toast: "Sale recorded: X units of [Title] - $X,XXX.XX", Form clears except Sales Channel, Focus returns to Title field</criterion>
    <criterion id="11">Error handling - Validation errors shown inline below fields, Server errors shown in toast notification, Network error: "Failed to record sale. Please try again.", Title not found: "Selected title no longer available"</criterion>
    <criterion id="12">Permission enforcement - Only Editor, Finance, Admin, or Owner can access, Redirect unauthorized users to dashboard with error toast, Server Action checks permissions before insert</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Sales Transaction Management (FR24-29)</section>
        <snippet>FR24: Editors can record individual sales transactions in real-time. FR25: Users can specify sale details (title, format, quantity, unit price, sale date, channel). FR26: System supports multiple sales channels (retail, wholesale, direct, distributor).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>Server Actions Pattern, Currency Handling</section>
        <snippet>Server Actions provide type-safe mutations. Use Decimal.js for financial calculations without floating-point errors. All queries auto-inject tenant_id. Permission checks before database operations.</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>Spacious Guided Flow Pattern</section>
        <snippet>Sales Transaction Entry (Daily Task) uses Spacious Guided Flow for quick data entry. Optimize for repetition - daily tasks should be lightning-fast. Clear information hierarchy, consistent patterns.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Definitions</title>
        <section>Epic 3: Sales &amp; Returns Processing</section>
        <snippet>Story 3.2 implements FR24 (record sales), FR25 (sale details), FR26 (sales channels). Follow UX Journey 1 "Record Sales Transaction" exactly. Use React Hook Form + Zod.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/db/schema/sales.ts</path>
        <kind>schema</kind>
        <symbol>sales, Sale, InsertSale, salesChannelValues, salesFormatValues</symbol>
        <lines>1-215</lines>
        <reason>Database schema for sales table with enums, CHECK constraints, and indexes. APPEND-ONLY ledger - no UPDATE/DELETE.</reason>
      </artifact>
      <artifact>
        <path>src/modules/sales/schema.ts</path>
        <kind>validation</kind>
        <symbol>createSaleSchema, salesChannelSchema, salesFormatSchema, positiveCurrencySchema, positiveIntegerSchema, CreateSaleInput</symbol>
        <lines>1-118</lines>
        <reason>Zod validation schemas for sales form validation. createSaleSchema validates all form fields. Use for both client and server validation.</reason>
      </artifact>
      <artifact>
        <path>src/lib/auth.ts</path>
        <kind>utility</kind>
        <symbol>getCurrentTenantId, getDb, getCurrentUser, requirePermission, hasPermission</symbol>
        <lines>1-129</lines>
        <reason>Auth utilities for getting tenant context, authenticated database connection, current user, and permission checking.</reason>
      </artifact>
      <artifact>
        <path>src/lib/permissions.ts</path>
        <kind>constants</kind>
        <symbol>RECORD_SALES</symbol>
        <lines>18-19</lines>
        <reason>Permission constant RECORD_SALES = ["owner", "admin", "editor", "finance"] for Server Action permission check.</reason>
      </artifact>
      <artifact>
        <path>src/lib/types.ts</path>
        <kind>types</kind>
        <symbol>ActionResult</symbol>
        <lines>1-3</lines>
        <reason>Standard ActionResult&lt;T&gt; type for Server Action responses. Use for recordSale return type.</reason>
      </artifact>
      <artifact>
        <path>src/modules/titles/actions.ts</path>
        <kind>actions</kind>
        <symbol>createTitle, updateTitle, fetchTitles</symbol>
        <lines>1-216</lines>
        <reason>Reference pattern for Server Actions - permission check, validation, tenant scoping, error handling, revalidatePath.</reason>
      </artifact>
      <artifact>
        <path>src/modules/titles/queries.ts</path>
        <kind>queries</kind>
        <symbol>getTitles, getTitleById</symbol>
        <lines>1-96</lines>
        <reason>Reference pattern for database queries - tenant scoping, filtering, relations. Use as template for searchTitlesForSales.</reason>
      </artifact>
      <artifact>
        <path>src/components/ui/command.tsx</path>
        <kind>component</kind>
        <symbol>Command, CommandInput, CommandList, CommandItem</symbol>
        <lines>full</lines>
        <reason>shadcn/ui Command component for autocomplete implementation (cmdk library).</reason>
      </artifact>
      <artifact>
        <path>src/components/ui/popover.tsx</path>
        <kind>component</kind>
        <symbol>Popover, PopoverTrigger, PopoverContent</symbol>
        <lines>full</lines>
        <reason>shadcn/ui Popover for dropdown autocomplete.</reason>
      </artifact>
      <artifact>
        <path>src/components/ui/select.tsx</path>
        <kind>component</kind>
        <symbol>Select, SelectTrigger, SelectContent, SelectItem, SelectValue</symbol>
        <lines>full</lines>
        <reason>shadcn/ui Select for Format and Channel dropdowns.</reason>
      </artifact>
      <artifact>
        <path>src/components/ui/form.tsx</path>
        <kind>component</kind>
        <symbol>Form, FormField, FormItem, FormLabel, FormControl, FormMessage</symbol>
        <lines>full</lines>
        <reason>shadcn/ui Form components integrated with React Hook Form.</reason>
      </artifact>
      <artifact>
        <path>src/components/ui/input.tsx</path>
        <kind>component</kind>
        <symbol>Input</symbol>
        <lines>full</lines>
        <reason>shadcn/ui Input for quantity and unit price fields.</reason>
      </artifact>
      <artifact>
        <path>src/components/ui/button.tsx</path>
        <kind>component</kind>
        <symbol>Button</symbol>
        <lines>full</lines>
        <reason>shadcn/ui Button for submit button with loading state.</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="react-hook-form" version="^7.66.1">Form state management</package>
        <package name="@hookform/resolvers" version="^5.2.2">Connects React Hook Form with Zod</package>
        <package name="zod" version="^4.1.12">Schema validation</package>
        <package name="decimal.js" version="^10.6.0">Financial calculations without floating-point errors</package>
        <package name="date-fns" version="^4.1.0">Date formatting</package>
        <package name="@date-fns/tz" version="1.4.1">Timezone support</package>
        <package name="cmdk" version="1.1.1">Command/combobox component (used by shadcn/ui)</package>
        <package name="sonner" version="2.0.7">Toast notifications</package>
        <package name="lucide-react" version="0.554.0">Icons</package>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="architecture.md">ALWAYS use tenant_id in WHERE clause as first condition for all queries.</constraint>
    <constraint source="architecture.md">NEVER use JavaScript +, -, *, / for currency calculations - use Decimal.js.</constraint>
    <constraint source="architecture.md">Server Actions must: 1) Validate with Zod, 2) Check permissions with requirePermission, 3) Get tenant context, 4) Execute, 5) Revalidate, 6) Return ActionResult.</constraint>
    <constraint source="db/schema/sales.ts">Sales are APPEND-ONLY (immutable ledger). No UPDATE or DELETE operations.</constraint>
    <constraint source="prd.md">FR29: System prevents modification of historical transactions.</constraint>
    <constraint source="story">Use "Spacious Guided Flow" UX pattern - form centered, max-width constraint, clear hierarchy.</constraint>
    <constraint source="story">Debounce title search at 300ms using Server Action.</constraint>
    <constraint source="story">Remember last-used channel in localStorage, default to "retail".</constraint>
    <constraint source="story">Sale date cannot be future date.</constraint>
    <constraint source="story">Format dropdown disabled until title selected, shows only formats with assigned ISBN.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>ActionResult&lt;T&gt;</name>
      <kind>TypeScript type</kind>
      <signature>type ActionResult&lt;T&gt; = { success: true; data: T } | { success: false; error: string; fields?: Record&lt;string, string&gt; }</signature>
      <path>src/lib/types.ts</path>
    </interface>
    <interface>
      <name>getCurrentTenantId</name>
      <kind>function</kind>
      <signature>async function getCurrentTenantId(): Promise&lt;string&gt;</signature>
      <path>src/lib/auth.ts</path>
    </interface>
    <interface>
      <name>getDb</name>
      <kind>function</kind>
      <signature>async function getDb(): Promise&lt;AuthenticatedDb&gt;</signature>
      <path>src/lib/auth.ts</path>
    </interface>
    <interface>
      <name>getCurrentUser</name>
      <kind>function</kind>
      <signature>async function getCurrentUser(): Promise&lt;User | null&gt;</signature>
      <path>src/lib/auth.ts</path>
    </interface>
    <interface>
      <name>requirePermission</name>
      <kind>function</kind>
      <signature>async function requirePermission(allowedRoles: UserRole[]): Promise&lt;void&gt;</signature>
      <path>src/lib/auth.ts</path>
    </interface>
    <interface>
      <name>RECORD_SALES</name>
      <kind>constant</kind>
      <signature>const RECORD_SALES: UserRole[] = ["owner", "admin", "editor", "finance"]</signature>
      <path>src/lib/permissions.ts</path>
    </interface>
    <interface>
      <name>createSaleSchema</name>
      <kind>Zod schema</kind>
      <signature>z.object({ title_id, format, quantity, unit_price, total_amount, sale_date, channel })</signature>
      <path>src/modules/sales/schema.ts</path>
    </interface>
    <interface>
      <name>sales table insert</name>
      <kind>Drizzle insert</kind>
      <signature>db.insert(sales).values({ tenant_id, title_id, format, quantity, unit_price, total_amount, sale_date, channel, created_by_user_id }).returning()</signature>
      <path>src/db/schema/sales.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Use Vitest for unit tests with jsdom environment. Use Playwright for E2E tests. Unit tests in tests/unit/, E2E in tests/e2e/. Test setup in tests/setup.ts. Use @/ path alias for imports. Test patterns: describe blocks for grouping, it/test for individual tests, expect assertions. E2E uses custom fixtures from tests/support/fixtures/.</standards>
    <locations>
      <location>tests/unit/sales-form.test.ts (NEW)</location>
      <location>tests/e2e/sales-entry.spec.ts (NEW)</location>
      <location>tests/unit/sales-schema.test.ts (EXISTS - schema validation already tested)</location>
      <location>tests/e2e/sales.spec.ts (EXISTS - has framework for sales tests)</location>
    </locations>
    <ideas>
      <idea ac="1">E2E: Verify page renders with correct header, subtitle, and centered layout</idea>
      <idea ac="2">E2E: Test title autocomplete shows results with author name and format badges, Unit: Test debounce behavior</idea>
      <idea ac="3">E2E: Test format dropdown is disabled until title selected, shows only available formats</idea>
      <idea ac="4">Unit: Test positiveIntegerSchema rejects 0, negatives, decimals. E2E: Test validation error display</idea>
      <idea ac="5">Unit: Test positiveCurrencySchema accepts valid, rejects &gt;2 decimals. E2E: Test currency formatting</idea>
      <idea ac="6">E2E: Test date picker defaults to today, rejects future dates</idea>
      <idea ac="7">E2E: Test channel remembers last selection in localStorage</idea>
      <idea ac="8">Unit: Test Decimal.js calculation accuracy. E2E: Test live total updates</idea>
      <idea ac="9">E2E: Test submit button shows total, disables when invalid, shows spinner</idea>
      <idea ac="10">E2E: Test successful submission shows toast, clears form except channel, returns focus to title</idea>
      <idea ac="11">E2E: Test validation errors inline, server errors in toast</idea>
      <idea ac="12">E2E: Test editor can access, author role redirected, Server Action permission check</idea>
    </ideas>
  </tests>
</story-context>
