# Epic 7 Retrospective: Contact & ISBN Foundation

**Date**: December 6, 2025
**Facilitator**: Bob (Scrum Master)
**Attendees**: BMad (Project Lead)

---

## Executive Summary

Epic 7 completed with **6/6 stories delivered** (100% completion rate). The epic established a unified contact system with multi-role support, publisher ISBN prefix system, customizable royalty periods, and removed the artificial ISBN type distinction.

**Key Achievement**: Unified contact database replacing the single-purpose authors table, enabling future Customer, Vendor, and Distributor roles.

**Critical Discovery**: Navigation shows both "Authors" and "Contacts" creating UX contradiction. Cleanup story 0.5 created.

**Live Bug Fix**: ISBN Type selector was still present in import form despite Story 7.6 being marked complete. Fixed during retrospective session.

---

## Epic 7 Delivery Metrics

### Story Completion

| Story | Description | Status |
|-------|-------------|--------|
| 7.1 | Create Unified Contact Database Schema | done |
| 7.2 | Build Contact Management Interface | done |
| 7.3 | Migrate Authors to Contacts | done (code complete, migration scripts ready) |
| 7.4 | Implement Publisher ISBN Prefix System | done |
| 7.5 | Add Customizable Royalty Period Setting | done |
| 7.6 | Remove ISBN Type Distinction | done |

- **Total Stories**: 6
- **Completed**: 6 (100%)
- **Infrastructure Stories Completed**: 1 (Story 0.4 - fix test failures)

### Quality Metrics

- **Live Bug Found During Retro**: 1 (ISBN Type selector in import form)
- **UX Issues Identified**: 1 (Authors/Contacts navigation contradiction)
- **Infrastructure Stories Created**: 1 (Story 0.5)

### Business Outcomes

- Unified contact database with multi-role support (Author, Customer, Vendor, Distributor)
- Contacts can have multiple roles simultaneously
- Publisher ISBN prefix registration with auto-generation
- Async ISBN generation for large blocks (>1000) via Inngest
- Customizable royalty period settings (Calendar Year, Fiscal Year, Custom)
- Simplified ISBN pool without type distinction

---

## Previous Retrospective Follow-Through (Epic 6)

| Action Item | Priority | Epic 6 Status | Epic 7 Follow-Through |
|-------------|----------|---------------|----------------------|
| Story 0.4: Fix 18 failing tests | CRITICAL | pending | DONE |
| Story 0.4: Fix TypeScript errors | HIGH | pending | DONE |
| Update Story 6.6 task checkboxes | MEDIUM | pending | UNCLEAR |
| Populate Story 6.6 Dev Agent Record | MEDIUM | pending | UNCLEAR |

**Impact**: Critical items (test failures, TypeScript errors) addressed before Epic 7.

---

## What Went Well

### 1. Unified Contact Architecture

The multi-role contact system was well-designed:
- Single `contacts` table with `contact_roles` junction table
- Role-specific data stored in JSONB (flexible, type-safe)
- Clean migration path from authors to contacts
- Backward compatibility maintained via query wrappers

### 2. ISBN Prefix System

Story 7.4 delivered robust ISBN prefix management:
- Automatic ISBN-13 generation with proper check digits
- Inngest for async generation of large blocks
- Progress polling in UI
- Prefix-based filtering in ISBN pool

### 3. Real-Time Bug Discovery

BMad caught the ISBN Type selector still present in the import form during this retrospective. The issue was:
- Story 7.6 marked "review" with all ACs checked
- But `isbn-import-form.tsx` still had the Physical/Ebook radio selector
- Fixed immediately during retrospective session

### 4. Clean Story Dependencies

Stories built on each other logically:
- 7.1 (schema) → 7.2 (UI) → 7.3 (migration)
- 7.4 (prefixes) enhanced ISBN pool
- 7.5 (royalty periods) enhanced statement generation
- 7.6 (type removal) simplified the entire ISBN model

---

## What Could Be Improved

### 1. Authors/Contacts Navigation Contradiction (CRITICAL)

**Issue**: Navigation shows both "Authors" (→ /authors) and "Contacts" (→ /contacts)

**Root Cause**: Story 7.3 migrated data and updated queries, but didn't update navigation to reflect the unified model.

**Impact**: Users confused about which to use; appears like duplicate data.

**Resolution**: Story 0.5 created to consolidate Authors into Contacts navigation.

### 2. Story 7.6 Review Gap

**Issue**: Story 7.6 was marked with all ACs checked, but the ISBN Import form still had the type selector.

**Root Cause**: Code review didn't verify the actual running application.

**Impact**: Users still saw Physical/Ebook type selection when importing ISBNs.

**Resolution**: Fixed during retrospective. Future reviews should include UI verification.

### 3. Story 7.3 Deployment Phase Unclear

**Issue**: Story 7.3 is "code complete" but migration scripts haven't been run.

**Impact**: The author-to-contacts migration exists in code but isn't active.

**Action Needed**: Run migration scripts as part of deployment process.

---

## Patterns & Learnings

### Established Patterns to Reuse

**1. Multi-Role Entity Pattern** (Story 7.1):
```
Table: contacts (base entity)
Table: contact_roles (role junction with role_specific_data JSONB)
```

**2. Prefix-Based Generation** (Story 7.4):
- Small blocks (<=1000): Synchronous generation
- Large blocks (>1000): Inngest async job with batching
- Progress polling in UI

**3. Tenant-Level Settings** (Story 7.5):
- Enum types for setting values
- Conditional field validation with Zod superRefine
- Preview display for user confirmation

**4. Backward Compatibility During Migration** (Story 7.3):
- Keep legacy files with @deprecated
- Query wrappers return familiar types
- Gradual transition without breaking changes

### Technical Debt Carried Forward

| Item | Source | Priority | Resolution |
|------|--------|----------|------------|
| Authors/Contacts navigation contradiction | Epic 7 | HIGH | Story 0.5 |
| Story 7.3 migration deployment | Epic 7 | MEDIUM | Deployment procedure |

---

## Action Items

| # | Action | Owner | Priority | Deadline |
|---|--------|-------|----------|----------|
| 1 | **Story 0.5**: Consolidate Authors into Contacts | Dev | HIGH | Before Epic 8 |
| 2 | Run Story 7.3 migration scripts | Ops | MEDIUM | Deployment |
| 3 | Add UI verification to code review checklist | SM | LOW | Ongoing |

---

## Infrastructure Story 0.5

**Story 0.5: Consolidate Authors into Contacts**

| Task | Description |
|------|-------------|
| 0.5.1 | Remove "Authors" from navigation |
| 0.5.2 | Redirect /authors → /contacts?role=author |
| 0.5.3 | Add URL param support for role filter |
| 0.5.4 | Update UI text references |
| 0.5.5 | Add @deprecated to authors module |
| 0.5.6 | Update tests |

---

## Team Agreements

- Verify running application during code review, not just code
- Cleanup stories should be completed before starting new epic work
- Navigation should reflect data model (unified contacts = single nav item)

---

## Critical Path

```
Story 0.5 (Authors/Contacts consolidation) ──► Epic 8 Planning
Story 7.3 Migration Deployment ──► Production contacts system active
```

---

## Retrospective Metrics

**Session Duration**: ~25 minutes
**Significant Discoveries**: 2 (navigation contradiction, ISBN type selector bug)
**Infrastructure Stories Created**: 1 (Story 0.5)
**Live Bug Fixes**: 1 (ISBN import form)
**Action Items Created**: 3

**Team Sentiment**: Proud of unified contact architecture, committed to fixing UX contradiction.

---

## Conclusion

Epic 7 successfully delivered a unified contact and ISBN foundation system. The 100% story completion rate and clean architectural patterns demonstrate strong execution. The multi-role contact system sets the foundation for Epic 8 (Invoicing & Accounts Receivable) where Customer contacts will be used.

Key issues identified:
1. Navigation contradiction (Authors + Contacts) - Story 0.5 created
2. Review gap (ISBN type selector missed) - Fixed during session

**Epic 7 Status**: COMPLETE
**Epic 8 Status**: Blocked pending Story 0.5 completion

**Next Steps**:
1. Execute Story 0.5 (consolidate Authors into Contacts)
2. Run Story 7.3 migration scripts during deployment
3. Plan Epic 8 when Story 0.5 is complete

---

**Retrospective Facilitated By**: Bob (Scrum Master)
**Document Version**: 1.0
**Date**: December 6, 2025
