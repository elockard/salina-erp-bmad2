# Epic 10 Retrospective: Advanced Royalty Features

**Date:** 2025-12-10
**Facilitator:** Bob (Scrum Master)
**Epic Status:** Complete (4/4 stories done)

---

## Epic Summary

| Metric | Value |
|--------|-------|
| Epic | 10 - Advanced Royalty Features |
| Stories Completed | 4/4 (100%) |
| FRs Implemented | FR111-118 (8 FRs) |
| Business Value | Co-authored book market + sophisticated royalty structures |

### Stories Delivered

| Story | Title | Status | Key Tests |
|-------|-------|--------|-----------|
| 10-1 | Add Multiple Authors Per Title with Ownership Percentages | Done | 135 unit, 25 integration |
| 10-2 | Implement Split Royalty Calculation Engine | Done | 28 unit |
| 10-3 | Generate Split Royalty Statements for Co-Authors | Done | 17 unit, 26 integration |
| 10-4 | Implement Escalating Lifetime Royalty Rates | Done | 55+ unit, 26 integration |

### Technical Highlights

- `title_authors` junction table with 100% ownership validation (Decimal.js precision)
- Split calculation engine with per-author advance recoupment
- Lifetime tier calculation with mid-period transitions
- Comprehensive audit trails for ownership and calculation mode changes

---

## What Went Well

### 1. Sequential Story Design
Stories 10.1 → 10.2 → 10.3 → 10.4 had clear prerequisites and blocking relationships. Each built on the previous foundation.

### 2. Decimal.js Discipline
Every story explicitly required Decimal.js for financial calculations. Zero floating-point bugs across ownership validation, split calculations, and lifetime tier transitions.

### 3. Test Coverage
200+ tests across the epic. Story 10.1 alone had 135 unit tests and 25 integration tests.

### 4. Thorough Dev Notes
Migration SQL patterns, algorithm overviews, and edge case documentation in each story file made implementation clearer.

### 5. Code Reviews Caught Real Issues
Story 10.2 code review found N+1 query pattern, console.warn that should've been an error, and dynamic imports that needed to be static. All fixed before merge.

---

## Challenges & Issues

### 1. Workflow Tracking Breakdown (HIGH PRIORITY)

**Problem:** Stories went through the process multiple times without catching legitimate issues. Sprint-status.yaml drifted out of sync with actual story states.

**Impact:** Created confusion about what was actually done vs still in-flight.

**Root Cause:** Unknown - needs investigation.

**Action Required:** Establish clearer "Definition of Done" criteria before Epic 11.

### 2. Technical Debt Deferred

| Item | Story | Priority |
|------|-------|----------|
| Integration tests pending | 10.2 Task 7 | Medium |
| Inngest author-centric approach (redundant calculations) | 10.2 | Low (Future) |
| E2E tests require manual testing | 10.4 | Low |

### 3. Pre-existing Test Failures

Stories noted pre-existing TypeScript errors in unrelated test files (invoice-actions, isbn-import) and 8 test failures from Story 7.3 `author_id` schema migration.

---

## Significant Discovery

### IRS 1099 Royalty Threshold Error

| Item | Documented in Epic 11 | Actual (2025 Tax Year) |
|------|----------------------|------------------------|
| 1099-MISC Royalty Threshold | $600 | **$10** |

**Impact:**
- Story 11.2 acceptance criteria are incorrect
- Nearly all authors with any royalty payment will require 1099
- Volume of 1099 generation significantly higher than planned

**Required Action:** Update Epic 11 in docs/epics.md before implementation.

---

## Action Items

### Process Improvements

| # | Action Item | Owner | Priority |
|---|-------------|-------|----------|
| 1 | Investigate root cause of story churn (multiple reviews without legitimate findings) | Bob (SM) | High |
| 2 | Establish clearer "Definition of Done" criteria | Team | High |
| 3 | Keep sprint-status.yaml in sync with actual story states | Dev Agent | Medium |

### Technical Debt

| # | Item | Owner | Priority |
|---|------|-------|----------|
| 1 | Story 10.2: Complete integration tests (Task 7) | Charlie | Medium |
| 2 | Story 10.2: Refactor Inngest to title-centric approach | Charlie | Low (Future) |
| 3 | Fix pre-existing test failures from Story 7.3 | Dana | Medium |

---

## Epic 11 Preparation Tasks

### Critical Path (Before Epic 11 Starts)

| # | Task | Owner |
|---|------|-------|
| 1 | **Update Epic 11 with correct $10 royalty threshold** | Alice (PO) |
| 2 | Update sprint-status.yaml to mark Epic 10 as done | Bob (SM) |
| 3 | Run `*sprint-planning` to refresh for Epic 11 | Bob (SM) |

### Research/Preparation

| # | Task | Owner |
|---|------|-------|
| 4 | Research TIN encryption approach | Charlie |
| 5 | Review IRS 1099-MISC requirements for 2025 | Alice (PO) |

---

## Next Epic Status

**Epic 11: Tax & Compliance**
- Goal: Generate IRS 1099-MISC forms for authors earning $10+ annually
- Stories: 3 (11-1, 11-2, 11-3)
- FRs: FR119-124

**Dependencies on Epic 10:**
- Statements infrastructure supports split royalties
- 1099 earnings must account for co-author splits
- Each author's 1099 reflects individual earnings, not title totals

---

## Lessons Learned

1. **Track status in real-time** - Don't let sprint-status.yaml drift
2. **Define "done" clearly** - Prevents unnecessary review cycles
3. **Retrospectives catch requirements errors** - $10 threshold discovery saved potential compliance failure
4. **Technical debt is okay if documented** - Integration tests can follow if unit tests are solid

---

## Team Acknowledgments

- **BMad** - Sharp catch on IRS $10 royalty threshold
- **Dev Team** - Solid technical execution with comprehensive testing
- **Code Reviewers** - Caught real issues (N+1 queries, production console.warn)

---

*Retrospective facilitated by Bob (Scrum Master Agent)*
